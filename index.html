<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- iOS notch + proper scaling -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Jemma & Clay Countdown Page</title>
  <style>
    :root{
      --bg1:#ffdde1;
      --bg2:#ee9ca7;
      --pink:#ff85a2;
      --pink-dark:#ff4e80;

      /* Layout vars */
      --vhpx: 100vh;     /* JS updates this for iOS */
      --tabs-h: 56px;    /* tabs bar height */
    }

    /* Move gradient to html to avoid iOS "pink flash" */
    html{
      background: linear-gradient(to bottom right, var(--bg1), var(--bg2));
      background-color: var(--bg1); /* solid fallback */
      min-height: 100svh;           /* safer unit on iOS */
    }

    /* Base */
    html, body{
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
      min-height: 100svh;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
    }
    body{
      background: transparent;
      /* IMPORTANT: previously had overflow:hidden; — removed to prevent iOS scroll freeze */
    }

    /* Tabs (auto-themed via body class) */
    .tabs {
      display:flex;
      gap:.5rem;
      padding:.75rem 1rem;
      position: sticky;
      top:0;
      z-index:1000;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      transform: translateZ(0);      /* promote to own layer */
      backface-visibility: hidden;
      /* notch-safe padding */
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right:max(1rem, env(safe-area-inset-right));
      padding-top: max(.75rem, calc(env(safe-area-inset-top)));
    }
    body.theme-past .tabs {
      background: linear-gradient(to bottom right, #ffdde1, #ee9ca7); /* Korea (pink) */
    }
    body.theme-mini .tabs {
      background: linear-gradient(135deg, #0d47a1 0%, #1976d2 45%, #64b5f6 100%); /* Greece (blue) */
    }
    body.theme-new .tabs {
      background: linear-gradient(135deg, #002868 0%, #f2f2f2 50%, #bf0a30 100%); /* USA */
    }

    .tab-btn{
      border:none;
      padding:.6rem 1rem;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      color:#fff;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 4px 10px rgba(0,0,0,.15);
      transition: transform .15s ease, background .2s ease, box-shadow .2s ease;
    }
    .tab-btn.active{
      background:#ffffff;
      color:#cc2a59;
      box-shadow: 0 8px 20px rgba(0,0,0,.2);
      transform: translateY(-1px);
    }

    /* Sections — replace 100vh with iOS-safe calc using --vhpx */
    .section {
      /* Fill viewport below the tabs bar, without jank on iOS toolbar resize */
      min-height: calc(var(--vhpx) - var(--tabs-h));
      display:none;
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right:max(1rem, env(safe-area-inset-right));
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
    }
    .section.active { display:block; }

    .main-content {
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height: calc(var(--vhpx) - var(--tabs-h));
      text-align:center;
      transition: opacity 1.2s ease-in-out;
      position:relative;
      z-index:1;
      padding: 1rem;
    }
    .main-content.fade-out { opacity:0; }

    /* Play button (base + theme overrides) */
    .play-button {
      margin-left:auto;
      margin-top: 10px;
      font-size: 1.05em;
      padding: 10px 20px;
      border: none;
      border-radius: 12px;
      color: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: background-color 0.25s ease, transform .1s ease;
    }
    .play-button:active { transform: scale(.98); }

    body.theme-past .play-button { background-color: var(--pink); }
    body.theme-past .play-button:hover { background-color: var(--pink-dark); }
    body.theme-mini .play-button { background-color:#1565c0; }
    body.theme-mini .play-button:hover { background-color:#0d47a1; }
    body.theme-new .play-button { background-color:#bf0a30; }
    body.theme-new .play-button:hover { background-color:#8b0723; }

    /* Cute bits */
    .hearts { font-size: 2em; animation: floatHearts 2s infinite alternate ease-in-out; }
    @keyframes floatHearts { 0% { transform: translateY(0);} 100% { transform: translateY(-10px);} }

    .countdown { font-size: 3em; font-weight: bold; text-shadow: 0 0 20px rgba(255, 255, 255, 0.9); }
    .glow-heart { font-size: 4em; margin-top: 20px; animation: pulse 1.5s infinite; filter: drop-shadow(0 0 10px rgba(255, 0, 100, 0.7)); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
    .love-note { margin-top: 16px; font-size: 1.1em; max-width: 640px; opacity:.95 }
    .meta { opacity:.9; margin-top:.4rem; }

    /* Fullscreen reveal (no fixed background-attachment) */
    .reveal {
      position: fixed;
      inset:0;
      background-color: rgba(0,0,0,1);
      color: white;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      opacity: 0;
      z-index: 999;
      pointer-events: none;
      transition: opacity 1.2s ease-in-out;
      overflow: hidden;
      text-align:center;
      padding:1rem;
    }
    .reveal.show { opacity: 1; pointer-events: auto; }
    .reveal-name {
      font-size: 7em;
      color: white;
      text-shadow:
        0 0 20px rgba(255, 105, 135, 1),
        0 0 40px rgba(255, 105, 135, 0.8),
        0 0 60px rgba(255, 105, 135, 0.6);
      margin:0; line-height:1;
    }
    .reveal-sub {
      margin-top: 10px;
      font-size: 2em;
      color: white;
      text-shadow:
        0 0 10px rgba(255, 255, 255, 0.85),
        0 0 20px rgba(255, 105, 135, 0.45);
    }

    /* Flowers */
    .flower-scatter { position: absolute; inset:0; pointer-events: none; z-index:0; }
    .flower { position: absolute; width: 40px; height: 40px; opacity: 0;
      animation: floatFlower 6s ease-in-out infinite alternate, fadeIn 2s ease-in-out forwards; }
    @keyframes floatFlower { 0%{ transform: translateY(0) rotate(0deg);} 100%{ transform: translateY(-20px) rotate(30deg);} }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Responsiveness */
    @media (max-width: 600px) {
      .countdown { font-size: 2.1em; }
      .reveal-name { font-size: 4.6em; }
      .reveal-sub { font-size: 1.4em; }
    }

    /* --- Floating Stars for New Trip --- */
    #stars-new { position: absolute; inset: 0; pointer-events: none; z-index: 0; }
    .star { position: absolute; width: 18px; height: 18px; opacity: 0; color: white; font-size: 1.2em;
      animation: floatStar 8s ease-in-out infinite alternate, fadeInStar 2s ease-in-out forwards; }
    @keyframes floatStar { 0% { transform: translateY(0) rotate(0deg); opacity: 0.7; }
                           100% { transform: translateY(-30px) rotate(20deg); opacity: 1; } }
    @keyframes fadeInStar { from { opacity: 0; } to { opacity: 0.9; } }

    /* American theme for the New Trip tab */
    #new{
      position: relative;
      background: linear-gradient(135deg, #002868 0%, #f2f2f2 50%, #bf0a30 100%);
      color:#fff;
    }
    #new::before { content:""; position:absolute; inset:0; background: rgba(0,0,0,0.25); z-index:0; }
    #new .main-content, #new .reveal { position:relative; z-index:1; }
    #new h1 { text-shadow: 0 0 12px rgba(0,0,0,0.5); font-weight: 700; }
    #new .countdown { text-shadow: 0 0 15px rgba(0,0,0,0.6); }
    #new .glow-heart { color:#fff; filter: drop-shadow(0 0 8px rgba(255,255,255,0.7)); }
    #new .love-note { font-style: italic; opacity: .9; }

    /* Greece theme for FaceTime Reunion */
    #mini{
      position: relative;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.18), transparent 60%),
                  linear-gradient(135deg, #0d47a1 0%, #1976d2 45%, #64b5f6 100%);
      color:#fff;
    }
    #mini::before{
      content:""; position:absolute; inset:0;
      background: repeating-linear-gradient(to bottom, rgba(255,255,255,0.18) 0 18px, transparent 18px 36px);
      z-index:0;
    }
    #mini .main-content, #mini .reveal { position:relative; z-index:1; }
    #mini h1 { text-shadow: 0 0 16px rgba(0,0,0,.45); }
    #mini .glow-heart { filter: drop-shadow(0 0 10px rgba(255,255,255,.9)); }

    /* Floating icons for Greece tab */
    #icons-mini{ position:absolute; inset:0; pointer-events:none; z-index:0; }
    .greek-icon{ position:absolute; opacity:0; font-size: 1.4rem;
      animation: floatGreek 9s ease-in-out infinite alternate, fadeInGreek 2.5s ease-in-out forwards; }
    @keyframes floatGreek{ 0% { transform: translateY(0) rotate(0deg);} 100% { transform: translateY(-26px) rotate(12deg);} }
    @keyframes fadeInGreek{ from { opacity:0; } to { opacity:.95; } }

    /* iOS-specific overrides: keep scrolling fluid, curb heavy filters */
    @supports (-webkit-touch-callout: none){
      body{ overflow: visible !important; }
      .tabs{
        /* Tone down heavy blur if needed on iOS */
        -webkit-backdrop-filter: none !important;
        backdrop-filter: none !important;
        background: rgba(0,0,0,0.12);
      }
    }

    /* Reduce motion (battery/jank guard) */
    @media (prefers-reduced-motion: reduce){
      .hearts, .flower, .star, .greek-icon, .glow-heart { animation: none !important; }
      .tabs, .tab-btn { transition: none !important; }
    }
  </style>
</head>
<body class="theme-new"><!-- default class; auto-selection will change it -->

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn" data-tab="past">South Korea Aug '25</button>
    <button class="tab-btn" data-tab="mini">FaceTime Reunion</button>
    <button class="tab-btn" data-tab="new">America Sept '25</button>
    <button id="play-btn" class="play-button" onclick="playMusic()">🎵 Play Our Song</button>
  </div>

  <!-- PAST SECTION -->
  <section id="past" class="section">
    <div class="main-content">
      <div class="hearts">💕💫💕</div>
      <h1>When do Jemma and Clay meet next?</h1>
      <div class="countdown" id="countdown-past">Loading...</div>
      <div class="meta">📍 Pyeongtaek, South Korea</div>
      <div class="glow-heart">❤️</div>
      <div class="hearts">💞🌙💞</div>
      <p class="love-note">Towards the Future. Kohti tulevaisuutta. 미래를 향하여.</p>
    </div>

    <div class="reveal" id="reveal-past">
      <h1 class="reveal-name">JEMMA</h1>
      <p class="reveal-sub">Welcome home 🇰🇷</p>
      <div class="flower-scatter" id="flowers-past"></div>
    </div>
  </section>

  <!-- FACETIME (GREECE) SECTION -->
  <section id="mini" class="section">
    <div class="main-content">
      <div class="hearts">🇬🇷✨🇬🇷</div>
      <h1>FaceTime Countdown</h1>
      <div class="countdown" id="countdown-mini">Loading...</div>
      <div class="meta">📍 FaceTime</div>
      <div class="glow-heart">💙</div>
      <p class="love-note">Love you across the world and back!</p>
    </div>

    <!-- floating Greece icons -->
    <div id="icons-mini"></div>

    <div class="reveal" id="reveal-mini">
      <h1 class="reveal-name">FACETIME DAY</h1>
      <p class="reveal-sub">Welcome back from vacation 🇬🇷</p>
      <div class="flower-scatter" id="flowers-mini"></div>
    </div>
  </section>

  <!-- NEW TRIP SECTION -->
  <section id="new" class="section">
    <div class="main-content">
      <div class="hearts">✨🇺🇸✨</div>
      <h1>Jemma & Clay's Great American Trip</h1>
      <div class="countdown" id="countdown-new">Loading...</div>
      <div class="meta">📍 America</div>
      <div class="glow-heart">🤍</div>
      <p class="love-note">The grass is greener where you water it</p>
    </div>

    <!-- Stars layer for the New Trip -->
    <div id="stars-new"></div>

    <div class="reveal" id="reveal-new">
      <h1 class="reveal-name">JEMMA</h1>
      <p class="reveal-sub">Welcome to America 🇺🇸</p>
      <div class="flower-scatter" id="flowers-new"></div>
    </div>
  </section>

  <!-- Audio -->
  <audio id="bg-music" loop>
    <source src="song.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <script>
    /* ---------- iOS-safe viewport height (sets --vhpx to innerHeight) ---------- */
    (function setVhVar(){
      const set = () => {
        document.documentElement.style.setProperty('--vhpx', window.innerHeight + 'px');
      };
      set();
      window.addEventListener('resize', set, { passive: true });
      window.addEventListener('orientationchange', set, { passive: true });
    })();

    /* --------- Music --------- */
    function playMusic() {
      const audio = document.getElementById("bg-music");
      audio.muted = false;
      audio.play().catch(err => console.log("Autoplay blocked:", err));
    }

    /* --------- Tabs --------- */
    const tabButtons = document.querySelectorAll('.tab-btn');
    const sections = document.querySelectorAll('.section');
    const playBtn = document.getElementById('play-btn');

    function setActiveTab(tabId){
      // update buttons/sections
      tabButtons.forEach(b=>{
        b.classList.toggle('active', b.dataset.tab===tabId);
      });
      sections.forEach(s=>{
        s.classList.toggle('active', s.id===tabId);
      });
      // run activation logic (theme, timers, emoji, effects)
      handleTimerActivation(tabId);
      // scroll to top smoothly without trapping scroll
      requestAnimationFrame(() => window.scrollTo({ top: 0, behavior: 'smooth' }));
    }

    tabButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveTab(btn.dataset.tab), { passive: true });
    });

    /* --------- Cute FX helpers (transform + opacity only) --------- */
    function scatterFlowers(containerId, desired=80) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';

      // Cap counts on iOS to avoid heavy repaints
      const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const count = isiOS ? Math.min(desired, 30) : desired;

      const emojis = ['🌸','🌸','🌸','🌸','🌺'];
      for (let i = 0; i < count; i++) {
        const el = document.createElement('img');
        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 100 100'><text x='0' y='75' font-size='80'>${emoji}</text></svg>`;
        el.src = 'data:image/svg+xml,' + encodeURIComponent(svg);
        el.className = 'flower';
        el.style.left = `${Math.random()*100}vw`;
        el.style.top  = `${Math.random()*100}vh`;
        el.style.animationDuration = `${3 + Math.random()*3}s`;
        el.style.transform = `rotate(${Math.random()*360}deg)`;
        container.appendChild(el);
      }
    }

    function scatterStars(containerId, desired=40) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';

      const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const count = isiOS ? Math.min(desired, 24) : desired;

      for (let i = 0; i < count; i++) {
        const el = document.createElement('div');
        el.textContent = '⭐';
        el.className = 'star';
        el.style.left = `${Math.random() * 100}vw`;
        el.style.top  = `${Math.random() * 100}vh`;
        el.style.animationDuration = `${5 + Math.random() * 5}s`;
        el.style.transform = `rotate(${Math.random() * 360}deg)`;
        container.appendChild(el);
      }
    }

    function scatterGreekIcons(containerId, desired=40){
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';

      const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const count = isiOS ? Math.min(desired, 24) : desired;

      const icons = ['🏛️','🫒','🏛️','🫒','🌀','🌊'];
      for (let i = 0; i < count; i++){
        const el = document.createElement('div');
        el.textContent = icons[Math.floor(Math.random()*icons.length)];
        el.className = 'greek-icon';
        el.style.left = `${Math.random()*100}vw`;
        el.style.top  = `${Math.random()*100}vh`;
        el.style.animationDuration = `${6 + Math.random()*6}s`;
        el.style.transform = `rotate(${Math.random()*360}deg)`;
        container.appendChild(el);
      }
    }

    /* --------- Countdown engine (multi-section) --------- */
    const timers = new Map();

    function initCountdown(opts){
      const { countdownElId, revealElId, flowersElId, targetDate } = opts;

      function showReveal(){
        const rev = document.getElementById(revealElId);
        if (rev){ rev.classList.add('show'); }
        if (flowersElId) scatterFlowers(flowersElId);
      }

      function tick(){
        const now = Date.now();
        const dist = targetDate - now;

        if (dist <= 0){
          clearInterval(timers.get(countdownElId));
          timers.delete(countdownElId);
          const el = document.getElementById(countdownElId);
          if (el) el.textContent = '0d 0h 0m 0s';
          showReveal();
          return;
        }
        const days = Math.floor(dist / (1000*60*60*24));
        const hours = Math.floor((dist % (1000*60*60*24)) / (1000*60*60));
        const minutes = Math.floor((dist % (1000*60*60)) / (1000*60));
        const seconds = Math.floor((dist % (1000*60)) / 1000);
        const el = document.getElementById(countdownElId);
        if (el) el.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      }

      tick();
      const interval = setInterval(tick, 1000);
      timers.set(countdownElId, interval);

      // Pause timer when tab becomes hidden to reduce background work on iOS
      const visHandler = () => {
        if (document.hidden && timers.has(countdownElId)) {
          clearInterval(timers.get(countdownElId));
          timers.delete(countdownElId);
        }
      };
      document.addEventListener('visibilitychange', visHandler, { passive: true, once:true });
    }

    function stopAllTimers(){
      for (const [,id] of timers) clearInterval(id);
      timers.clear();
    }

    function handleTimerActivation(tabId){
      stopAllTimers();

      /* Switch body theme to recolor the top banner + play button */
      document.body.classList.remove('theme-past','theme-mini','theme-new');
      document.body.classList.add('theme-' + tabId);

      /* Update play button emoji per tab */
      if (tabId==='past'){ playBtn.textContent = "🎵 Play Our Song"; }
      else if (tabId==='mini'){ playBtn.textContent = "🎶 Play Our Song"; }
      else if (tabId==='new'){ playBtn.textContent = "🎸 Play Our Song"; }

      if (tabId === 'past'){
        initCountdown({
          countdownElId: 'countdown-past',
          revealElId: 'reveal-past',
          flowersElId: 'flowers-past',
          targetDate: PAST_TRIP_DATE.getTime()
        });
      } else if (tabId === 'mini'){
        initCountdown({
          countdownElId: 'countdown-mini',
          revealElId: 'reveal-mini',
          flowersElId: 'flowers-mini',
          targetDate: MINI_REUNION_DATE.getTime()
        });
        scatterGreekIcons('icons-mini');
      } else if (tabId === 'new'){
        initCountdown({
          countdownElId: 'countdown-new',
          revealElId: 'reveal-new',
          flowersElId: 'flowers-new',
          targetDate: NEW_TRIP_DATE.getTime()
        });
        scatterStars('stars-new');
      }
    }

    /* --------- DATES --------- */
    const PAST_TRIP_DATE = new Date("2025-08-08T11:00:55");               // Korea
    const MINI_REUNION_DATE = new Date("2025-09-02T00:00:00+03:00");      // Greece (Athens time)
    const NEW_TRIP_DATE  = new Date("2025-09-24T18:30:00-07:00");         // America (PDT)

    /* --------- Auto-select nearest upcoming tab --------- */
    function selectNearestTab(){
      const now = Date.now();
      const candidates = [
        { id: 'past', date: PAST_TRIP_DATE },
        { id: 'mini', date: MINI_REUNION_DATE },
        { id: 'new',  date: NEW_TRIP_DATE  },
      ];

      // Keep only future events; pick the one with the smallest positive remaining time
      const future = candidates
        .map(c => ({ id: c.id, ms: c.date.getTime() - now }))
        .filter(c => c.ms > 0)
        .sort((a,b) => a.ms - b.ms);

      const target = future.length ? future[0].id : 'new'; // fallback
      setActiveTab(target);
    }

    /* --------- Boot --------- */
    document.addEventListener('DOMContentLoaded', selectNearestTab, { passive: true });

    /* Defensive: no touchmove preventDefault; no fixed background-attachment anywhere */
  </script>
</body>
</html>
